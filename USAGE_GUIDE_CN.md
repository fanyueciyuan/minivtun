# minivtun 中文使用指南 (初学者)

欢迎使用 minivtun！本指南旨在帮助初学者理解 `minivtun` 的每一个配置选项，并快速搭建自己的 VPN 连接。

---

### 1. 核心概念

在开始之前，我们先了解几个基本概念：

*   **服务器 (Server) vs 客户端 (Client)**:
    *   **服务器**：是 VPN 的中心节点，通常部署在有公网 IP 的机器上，等待客户端的连接。
    *   **客户端**：是连接到服务器的设备，如你的笔记本电脑、手机等。

*   **TUN 模式 vs TAP 模式**:
    *   **TUN (网络隧道)**：工作在网络层（三层），模拟一个点对点的 IP 网络设备。它主要用于路由 IP 流量。这是最常用的模式。
    *   **TAP (网络桥接)**：工作在数据链路层（二层），模拟一个以太网设备。它可以传输以太网帧，常用于网络桥接，允许非 IP 协议（如 IPX）或需要二层广播的场景。**对于大多数 VPN 用途，你应该使用默认的 TUN 模式。**

---

### 2. 编译与安装

在开始使用前，请确保你已经编译好了 `minivtun`。推荐使用项目根目录下的 `build.sh` 脚本进行一键静态编译，它会自动处理所有依赖。

```bash
# 编译适用于当前系统的版本
./build.sh native

# 编译适用于 MIPS 路由器的版本 (例如 Newifi 3)
./build.sh mipsel
```
编译完成后，你将得到 `minivtun_x86_64` 或 `minivtun_mipsel` 这样的可执行文件。在后续的命令中，请使用你编译好的文件名。

---

### 3. 命令行选项详解

`minivtun` 的所有配置都通过命令行参数完成。下面是每个参数的详细解释。

#### **核心网络选项**

这些是建立连接最基本的选项。

*   `-l, --local <ip:port>` **(服务器专用)**
    *   **说明**: 指定服务器监听的 IP 地址和端口。客户端将连接到这个地址。
    *   **示例**: `-l 0.0.0.0:1414`
    *   **详解**: `0.0.0.0` 是一个特殊的 IP，表示监听本机上所有网络接口的 1414 端口。如果你只想让特定 IP（如 `192.168.1.100`）能被访问，可以指定它。

*   `-r, --remote <host:port>` **(客户端专用)**
    *   **说明**: 指定要连接的 `minivtun` 服务器的域名或 IP 地址及端口。
    *   **示例**: `-r your-server-domain.com:1414` 或 `-r 123.45.67.89:1414`

*   `-a, --ipv4-addr <tun_lip/pfx>`
    *   **说明**: 设置虚拟网卡的 IPv4 地址和网络掩码。这是你在 VPN 网络中的“内网IP”。
    *   **格式**: `虚拟IP/前缀长度`。
    *   **示例**:
        *   服务器: `-a 10.7.0.1/24` (服务器的虚拟IP是 `10.7.0.1`，整个VPN子网是 `10.7.0.0` 到 `10.7.0.255`)
        *   客户端: `-a 10.7.0.33/24` (客户端的虚拟IP是 `10.7.0.33`)
    *   **注意**: 同一个 VPN 网络中的所有设备都必须使用相同的前缀长度（`/24`），且虚拟 IP 不能冲突。

*   `-n, --ifname <ifname>`
    *   **说明**: 指定创建的虚拟网卡的名称。
    *   **示例**: `-n mv0`
    *   **详解**: 如果不指定，系统会自动命名（如 `mv0`, `mv1`...）。指定一个固定的名字有助于编写防火墙或路由脚本。

#### **安全与加密选项**

*   `-e, --key <password>`
    *   **说明**: 设置用于加密隧道数据的共享密钥（密码）。**这是必须的，否则数据将不加密！**
    *   **示例**: `-e 'YourSecretPassword123'`
    *   **注意**: 服务器和客户端的密钥必须完全一致。

*   `-t, --algo <cipher>`
    *   **说明**: 选择加密算法。
    *   **示例**: `-t aes-256`
    *   **详解**: 默认是 `aes-128`。支持的算法有: `aes-128`, `aes-256`, `des`, `desx`, `rc4`。`aes-256` 提供了更高的安全性。

#### **高级网络与路由选项**

*   `-m, --mtu <mtu>`
    *   **说明**: 设置虚拟网卡的“最大传输单元”(MTU)。
    *   **示例**: `-m 1400`
    *   **详解**: 默认是 `1300`。如果你的网络环境复杂（例如，经过多层 NAT 或其他隧道），减小 MTU 值可以避免数据包被分片，从而提高稳定性和性能。

*   `-v, --route <net/pfx>[=gw]`
    *   **说明**: 添加一条路由，使得特定网段的流量通过此 VPN 隧道。可以多次使用此选项来添加多条路由。
    *   **示例**: `-v 192.168.1.0/24`
    *   **详解**: 这个例子告诉系统，所有发往 `192.168.1.0/24` 网段的流量都应该从 `minivtun` 的虚拟网卡出去。这对于访问家庭或办公室的内部网络非常有用。

*   `-E, --tap`
    *   **说明**: 启用 TAP 模式（二层网络）。
    *   **详解**: 除非你明确知道需要桥接网络或传输非 IP 协议，否则不要使用此选项。

#### **进程与守护选项**

*   `-d, --daemon`
    *   **说明**: 让 `minivtun` 在后台作为守护进程运行。
    *   **详解**: 启动后，程序会释放终端，你可以关闭 SSH 连接而程序继续运行。推荐在服务器上使用。

*   `-p, --pidfile <pid_file>`
    *   **说明**: 当使用 `-d` 后台运行时，将进程的 PID 写入指定的文件。
    *   **示例**: `-p /var/run/minivtun.pid`
    *   **详解**: 这对于管理服务（如启动、停止）非常有用。

#### **客户端专用选项**

这些选项只在客户端模式下生效。

*   `-w, --wait-dns`
    *   **说明**: 在启动连接前，先等待系统的 DNS 服务正常工作。
    *   **详解**: 对于一些开机自启动的场景很有用，可以防止因网络未就绪导致域名解析失败。

*   `-R, --reconnect-timeo <seconds>`
    *   **说明**: 在连接断开或不活跃多少秒后，触发重新连接。
    *   **示例**: `-R 60` (如果 60 秒没有数据活动，则重连)
    *   **详解**: 默认是 `47` 秒。

*   `-K, --keepalive <seconds>`
    *   **说明**: 每隔多少秒发送一次“心跳包”来保持连接活跃。
    *   **示例**: `-K 10`
    *   **详解**: 默认是 `7` 秒。这有助于穿透某些会话超时的防火墙或 NAT 设备。

*   `-H, --health-file <path>`
    *   **说明**: 将实时的连接健康数据（如延迟、丢包率）写入指定文件。
    *   **示例**: `-H /tmp/minivtun_health.json`
    *   **详解**: 用于监控或自动化脚本。

*   `-P, --max-droprate <1-100>`
    *   **说明**: 允许的最大丢包率百分比。
    *   **详解**: 用于健康检查，如果丢包率超过此值，可能会触发重连或其他操作。

*   `-X, --max-rtt <ms>`
    *   **说明**: 允许的最大延迟（Round-Trip Time），单位是毫秒。
    *   **详解**: 用于健康检查。

---

### 4. 实用配置示例

#### **示例 1: 启动服务器**

假设服务器的公网 IP 是 `123.45.67.89`。我们希望 VPN 子网是 `10.10.0.0/24`，服务器自己的虚拟 IP 是 `10.10.0.1`。

```bash
# 使用你的可执行文件名，例如 minivtun_x86_64
sudo ./minivtun_x86_64 \
    -l 0.0.0.0:1414 \
    -a 10.10.0.1/24 \
    -n mv-server \
    -e 'MySuperSecurePassword@2023' \
    -d \
    -p /var/run/minivtun.pid
```

**解释**:
*   `-l 0.0.0.0:1414`: 在所有网络接口上监听 `1414` 端口。
*   `-a 10.10.0.1/24`: 设置服务器的虚拟 IP。
*   `-n mv-server`: 命名虚拟网卡为 `mv-server`。
*   `-e '...'`: 设置连接密码。
*   `-d`: 在后台运行。
*   `-p /var/run/minivtun.pid`: 将 PID 存入文件，方便管理。

#### **示例 2: 连接客户端**

现在，我们在笔记本电脑上启动客户端，连接到上面的服务器。

```bash
# 使用你的可执行文件名
sudo ./minivtun_x86_64 \
    -r 123.45.67.89:1414 \
    -a 10.10.0.101/24 \
    -n mv-client \
    -e 'MySuperSecurePassword@2023' \
    -v 10.10.0.0/24 \
    -v 192.168.1.0/24 \
    -d
```

**解释**:
*   `-r 123.45.67.89:1414`: 连接到我们的服务器。
*   `-a 10.10.0.101/24`: 为客户端分配虚拟 IP `10.10.0.101`。
*   `-n mv-client`: 命名虚拟网卡为 `mv-client`。
*   `-e '...'`: 使用和服务器相同的密码。
*   `-v 10.10.0.0/24`: 将所有到 VPN 子网的流量都通过隧道发送（这样才能访问到其他客户端）。
*   `-v 192.168.1.0/24`: **(可选)** 如果你想通过此 VPN 访问服务器所在地的局域网（例如 `192.168.1.0/24`），添加这条路由。
*   `-d`: 在后台运行。

现在，你的客户端应该已经连接到服务器，并且可以 `ping 10.10.0.1` 来测试连通性了！
