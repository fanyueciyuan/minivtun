# MiniVTun åˆå­¦è€…æŒ‡å—

## é¡¹ç›®æ¦‚è¿°

**MiniVTun** æ˜¯ä¸€ä¸ªè½»é‡çº§ã€é«˜æ€§èƒ½çš„ VPN éš§é“å·¥å…·ï¼Œé‡‡ç”¨éæ ‡å‡†åè®®å®ç°å¿«é€Ÿéƒ¨ç½²çš„ VPN æœåŠ¡å™¨/å®¢æˆ·ç«¯ã€‚

### æ ¸å¿ƒç‰¹ç‚¹

- **å¿«é€Ÿ**: ç›´æ¥ä½¿ç”¨ UDP å°è£…é€šä¿¡ï¼Œæ— éœ€å¤æ‚çš„æ¡æ‰‹è®¤è¯æµç¨‹
- **å®‰å…¨**: æ•°æ®å¤´å’Œéš§é“æ•°æ®éƒ½ç»è¿‡åŠ å¯†ï¼Œéš¾ä»¥é€šè¿‡åè®®ç‰¹å¾è¿½è¸ª
- **å¯é **: ä¼šè¯ä¸­æ–­åï¼Œä»ä¸‹ä¸€ä¸ªæ¥æ”¶çš„æ•°æ®åŒ…ç«‹å³æ¢å¤é€šä¿¡
- **æ˜“éƒ¨ç½²**: å•ä¸€å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ‰€æœ‰é…ç½®é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æŒ‡å®š
- **å¯ç§»æ¤**: æ”¯æŒ Linuxã€BSDã€macOS ç­‰å¤šå¹³å°ï¼Œå¯ç¼–è¯‘ä¸ºé™æ€äºŒè¿›åˆ¶

---

## ä»£ç ç»“æ„åˆ†æ

### æ–‡ä»¶ç»„ç»‡ (çº¦ 3178 è¡Œ C ä»£ç )

```
src/
â”œâ”€â”€ minivtun.c          (13K) - ä¸»ç¨‹åºå…¥å£ã€å‘½ä»¤è¡Œè§£æã€é…ç½®ç®¡ç†
â”œâ”€â”€ minivtun.h          (3.9K) - æ ¸å¿ƒæ•°æ®ç»“æ„å®šä¹‰
â”œâ”€â”€ client.c            (12K) - å®¢æˆ·ç«¯é€»è¾‘å®ç°
â”œâ”€â”€ server.c            (18K) - æœåŠ¡å™¨ç«¯é€»è¾‘å®ç°
â”œâ”€â”€ library.c           (11K) - é€šç”¨å·¥å…·å‡½æ•°åº“
â”œâ”€â”€ library.h           (5.4K) - å·¥å…·å‡½æ•°æ¥å£å®šä¹‰
â”œâ”€â”€ platform_linux.c    (8.2K) - Linux å¹³å°ç›¸å…³å®ç°
â”œâ”€â”€ platform_bsd.c      (5.6K) - BSD/macOS å¹³å°å®ç°
â”œâ”€â”€ platform.h          (840B) - å¹³å°æŠ½è±¡æ¥å£
â”œâ”€â”€ crypto_openssl.c    (4.4K) - OpenSSL åŠ å¯†å®ç°
â”œâ”€â”€ crypto_mbedtls.c    (5.4K) - mbedTLS åŠ å¯†å®ç°
â”œâ”€â”€ crypto_wrapper.h    (653B) - åŠ å¯†æŠ½è±¡æ¥å£
â”œâ”€â”€ list.h              (5.0K) - é“¾è¡¨æ•°æ®ç»“æ„
â”œâ”€â”€ jhash.h             (3.3K) - Jenkins Hash ç®—æ³•
â””â”€â”€ log.h               (532B) - æ—¥å¿—å®å®šä¹‰
```

---

## æ ¸å¿ƒæ•°æ®ç»“æ„

### 1. é…ç½®ç»“æ„ä½“ (`struct minivtun_config`)

ä½ç½®: `src/minivtun.h:33-73`

```c
struct minivtun_config {
    char ifname[40];              // è™šæ‹Ÿç½‘å¡æ¥å£å (ä¾‹å¦‚: mv0)
    unsigned tun_mtu;             // éš§é“ MTU å¤§å° (é»˜è®¤: 1300)
    unsigned tun_qlen;            // å‘é€é˜Ÿåˆ—é•¿åº¦ (é»˜è®¤: 500)
    const char *crypto_algo;      // åŠ å¯†ç®—æ³• (é»˜è®¤: aes-128)
    const char *crypto_passwd;    // åŠ å¯†å¯†ç 
    const char *pid_file;         // PID æ–‡ä»¶è·¯å¾„
    bool in_background;           // æ˜¯å¦åå°è¿è¡Œ
    bool tap_mode;                // TAP (L2) æ¨¡å¼ vs TUN (L3) æ¨¡å¼

    // IPv4/IPv6 åœ°å€é…ç½®
    struct in_addr tun_in_local;  // æœ¬åœ°éš§é“ IPv4 åœ°å€
    struct in_addr tun_in_peer;   // å¯¹ç«¯éš§é“ IPv4 åœ°å€
    int tun_in_prefix;            // IPv4 å‰ç¼€é•¿åº¦

    // åŠ¨æ€è·¯ç”±å’Œè™šæ‹Ÿè·¯ç”±
    struct vt_route *vt_routes;   // è·¯ç”±é“¾è¡¨

    // å®¢æˆ·ç«¯ä¸“ç”¨é…ç½®
    bool wait_dns;                // ç­‰å¾… DNS è§£æ
    unsigned exit_after;          // è¿è¡ŒæŒ‡å®šç§’æ•°åé€€å‡º
    bool dynamic_link;            // åŠ¨æ€é“¾è·¯ç®¡ç†
    unsigned reconnect_timeo;     // é‡è¿è¶…æ—¶ (é»˜è®¤: 47ç§’)
    unsigned max_droprate;        // æœ€å¤§å…è®¸ä¸¢åŒ…ç‡ (1-100)
    unsigned max_rtt;             // æœ€å¤§å¾€è¿”å»¶è¿Ÿ (æ¯«ç§’)
    unsigned keepalive_interval;  // ä¿æ´»é—´éš” (é»˜è®¤: 7ç§’)
    unsigned health_assess_interval; // å¥åº·è¯„ä¼°é—´éš” (é»˜è®¤: 60ç§’)
    unsigned nr_stats_buckets;    // ç»Ÿè®¡æ•°æ®æ¡¶æ•°é‡ (é»˜è®¤: 3)
    const char *health_file;      // å¥åº·æ•°æ®è¾“å‡ºæ–‡ä»¶
};
```

**å…³é”®ç‚¹**:
- æ”¯æŒ TUN (L3 IP) å’Œ TAP (L2 ä»¥å¤ªç½‘) ä¸¤ç§æ¨¡å¼
- å®¢æˆ·ç«¯å…·å¤‡å®Œå–„çš„å¥åº·ç›‘æ§å’Œè‡ªåŠ¨é‡è¿æœºåˆ¶
- æ”¯æŒè‡ªå®šä¹‰è·¯ç”±å’Œåº¦é‡å€¼ç®¡ç†

### 2. çŠ¶æ€å˜é‡ (`struct state_variables`)

ä½ç½®: `src/minivtun.h:90-119`

```c
struct state_variables {
    int tunfd;                    // TUN/TAP è®¾å¤‡æ–‡ä»¶æè¿°ç¬¦
    int sockfd;                   // UDP socket æ–‡ä»¶æè¿°ç¬¦
    struct crypto_context *crypto_ctx; // åŠ å¯†ä¸Šä¸‹æ–‡

    // å®¢æˆ·ç«¯çŠ¶æ€
    struct sockaddr_inx peer_addr;     // å¯¹ç«¯åœ°å€
    __u16 xmit_seq;                    // å‘é€åºåˆ—å·
    struct timeval last_recv;          // æœ€åæ¥æ”¶æ—¶é—´
    struct timeval last_echo_sent;     // æœ€å ECHO è¯·æ±‚æ—¶é—´
    struct timeval last_echo_recv;     // æœ€å ECHO å“åº”æ—¶é—´
    struct timeval last_health_assess; // æœ€åå¥åº·è¯„ä¼°æ—¶é—´
    bool is_link_ok;                   // é“¾è·¯æ˜¯å¦æ­£å¸¸
    bool health_based_link_up;         // åŸºäºå¥åº·çŠ¶æ€çš„é“¾è·¯æ§åˆ¶
    unsigned rt_metric;                // å½“å‰è·¯ç”±åº¦é‡å€¼

    // å¥åº·è¯„ä¼°æ•°æ®
    bool has_pending_echo;             // æ˜¯å¦æœ‰å¾…å¤„ç†çš„ ECHO
    __be32 pending_echo_id;            // å¾…å¤„ç†çš„ ECHO ID
    struct stats_data *stats_buckets;  // ç»Ÿè®¡æ•°æ®æ¡¶
    unsigned current_bucket;           // å½“å‰æ¡¶ç´¢å¼•

    // æœåŠ¡å™¨çŠ¶æ€
    struct sockaddr_inx local_addr;    // æœ¬åœ°ç›‘å¬åœ°å€
    struct timeval last_walk;          // æœ€åéå†æ—¶é—´
};
```

**å…³é”®ç‚¹**:
- å®¢æˆ·ç«¯ç»´æŠ¤è¯¦ç»†çš„è¿æ¥çŠ¶æ€å’Œå¥åº·æŒ‡æ ‡
- ä½¿ç”¨åºåˆ—å·æœºåˆ¶ä¿è¯æ•°æ®åŒ…é¡ºåº
- æœåŠ¡å™¨ç«¯éœ€è¦ç®¡ç†å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥

### 3. æ¶ˆæ¯åè®® (`struct minivtun_msg`)

ä½ç½®: `src/minivtun.h:131-158`

```c
struct minivtun_msg {
    struct {
        __u8 opcode;              // æ“ä½œç  (ECHO_REQ, IPDATA, DISCONNECT, ECHO_ACK)
        __u8 rsv;                 // ä¿ç•™å­—æ®µ
        __be16 seq;               // åºåˆ—å·
        __u8 auth_key[16];        // è®¤è¯å¯†é’¥ (16 å­—èŠ‚)
    } __attribute__((packed)) hdr; // 20 å­—èŠ‚

    union {
        struct {
            __be16 proto;         // åè®®ç±»å‹ (ETH_P_IP æˆ– ETH_P_IPV6)
            __be16 ip_dlen;       // IP æ•°æ®é•¿åº¦
            char data[];          // å®é™…æ•°æ® (æŸ”æ€§æ•°ç»„æˆå‘˜)
        } __attribute__((packed)) ipdata;

        struct {
            union {
                struct {
                    struct in_addr loc_tun_in;     // æœ¬åœ°éš§é“ IPv4 åœ°å€
                    struct in6_addr loc_tun_in6;   // æœ¬åœ°éš§é“ IPv6 åœ°å€
                };
                struct mac_addr loc_tun_mac;       // æœ¬åœ°éš§é“ MAC åœ°å€
            };
            __be32 id;            // ECHO ID
        } __attribute__((packed)) echo;
    };
} __attribute__((packed));
```

**æ¶ˆæ¯ç±»å‹**:
- `MINIVTUN_MSG_ECHO_REQ`: å¿ƒè·³è¯·æ±‚ (å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨)
- `MINIVTUN_MSG_IPDATA`: IP æ•°æ®åŒ…ä¼ è¾“
- `MINIVTUN_MSG_DISCONNECT`: æ–­å¼€è¿æ¥é€šçŸ¥
- `MINIVTUN_MSG_ECHO_ACK`: å¿ƒè·³å“åº” (æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯)

---

## æ ¸å¿ƒå·¥ä½œæµç¨‹

### æœåŠ¡å™¨ç«¯æµç¨‹ (`server.c`)

```
1. åˆå§‹åŒ–
   â”œâ”€â”€ ç»‘å®š UDP socket åˆ°æŒ‡å®šç«¯å£ (ä¾‹å¦‚: 0.0.0.0:1414)
   â”œâ”€â”€ åˆ›å»º TUN/TAP è™šæ‹Ÿç½‘å¡
   â”œâ”€â”€ é…ç½®è™šæ‹Ÿç½‘å¡ IP åœ°å€ (ä¾‹å¦‚: 10.7.0.1/24)
   â””â”€â”€ åˆå§‹åŒ–åŠ å¯†ä¸Šä¸‹æ–‡

2. ä¸»å¾ªç¯ (select å¤šè·¯å¤ç”¨)
   â”œâ”€â”€ ç›‘å¬ sockfd (UDP) å’Œ tunfd (è™šæ‹Ÿç½‘å¡)
   â”‚
   â”œâ”€â”€ sockfd å¯è¯» â†’ å¤„ç†å®¢æˆ·ç«¯æ•°æ®åŒ…
   â”‚   â”œâ”€â”€ recvfrom() æ¥æ”¶ UDP æ•°æ®
   â”‚   â”œâ”€â”€ è§£å¯†æ•°æ®åŒ…
   â”‚   â”œâ”€â”€ éªŒè¯æ¶ˆæ¯ç±»å‹
   â”‚   â”œâ”€â”€ ECHO_REQ â†’ å‘é€ ECHO_ACK
   â”‚   â”œâ”€â”€ IPDATA â†’ æŸ¥æ‰¾è·¯ç”±è¡¨ï¼Œå†™å…¥ tunfd
   â”‚   â””â”€â”€ æ›´æ–°å®¢æˆ·ç«¯è¿æ¥è¡¨ (ra_entry)
   â”‚
   â””â”€â”€ tunfd å¯è¯» â†’ è½¬å‘ IP æ•°æ®åˆ°å®¢æˆ·ç«¯
       â”œâ”€â”€ read() ä»è™šæ‹Ÿç½‘å¡è¯»å– IP åŒ…
       â”œâ”€â”€ è§£æç›®æ ‡ IP åœ°å€
       â”œâ”€â”€ æŸ¥æ‰¾è™šæ‹Ÿè·¯ç”±è¡¨ (vt_route_lookup)
       â”œâ”€â”€ æ‰¾åˆ°å¯¹åº”å®¢æˆ·ç«¯è¿æ¥
       â”œâ”€â”€ å°è£…ä¸º IPDATA æ¶ˆæ¯
       â”œâ”€â”€ åŠ å¯†æ•°æ®åŒ…
       â””â”€â”€ sendto() å‘é€åˆ°å®¢æˆ·ç«¯

3. è¿æ¥ç®¡ç†
   â””â”€â”€ å®šæœŸæ¸…ç†è¶…æ—¶å®¢æˆ·ç«¯è¿æ¥ (ä½¿ç”¨å“ˆå¸Œè¡¨ + LRU)
```

**å…³é”®å‡½æ•°**:
- `run_server()` (src/server.c:å¼€å§‹å¤„): ä¸»å¾ªç¯å…¥å£
- `vt_route_lookup()` (src/server.c:35): è™šæ‹Ÿè·¯ç”±æŸ¥æ‰¾
- `ra_entry_find()`: æŸ¥æ‰¾å®¢æˆ·ç«¯è¿æ¥è®°å½•
- `ra_entry_destroy()`: é”€æ¯è¶…æ—¶è¿æ¥

### å®¢æˆ·ç«¯æµç¨‹ (`client.c`)

```
1. åˆå§‹åŒ–
   â”œâ”€â”€ è§£ææœåŠ¡å™¨åœ°å€ (æ”¯æŒ DNS è§£æ)
   â”œâ”€â”€ åˆ›å»º UDP socket
   â”œâ”€â”€ åˆ›å»º TUN/TAP è™šæ‹Ÿç½‘å¡
   â”œâ”€â”€ é…ç½®æœ¬åœ° IP åœ°å€ (ä¾‹å¦‚: 10.7.0.33/24)
   â”œâ”€â”€ æ·»åŠ è·¯ç”±è§„åˆ™ (å¯é€‰)
   â””â”€â”€ åˆå§‹åŒ–åŠ å¯†ä¸Šä¸‹æ–‡

2. ä¸»å¾ªç¯ (select å¤šè·¯å¤ç”¨)
   â”œâ”€â”€ ç›‘å¬ sockfd (UDP) å’Œ tunfd (è™šæ‹Ÿç½‘å¡)
   â”‚
   â”œâ”€â”€ sockfd å¯è¯» â†’ æ¥æ”¶æœåŠ¡å™¨æ•°æ®
   â”‚   â”œâ”€â”€ recvfrom() æ¥æ”¶æ•°æ®
   â”‚   â”œâ”€â”€ è§£å¯†æ•°æ®åŒ…
   â”‚   â”œâ”€â”€ ECHO_ACK â†’ æ›´æ–° RTT å’Œå¥åº·ç»Ÿè®¡
   â”‚   â”œâ”€â”€ IPDATA â†’ å†™å…¥ tunfd
   â”‚   â””â”€â”€ æ›´æ–° last_recv æ—¶é—´æˆ³
   â”‚
   â”œâ”€â”€ tunfd å¯è¯» â†’ å‘é€æœ¬åœ° IP åŒ…åˆ°æœåŠ¡å™¨
   â”‚   â”œâ”€â”€ read() ä»è™šæ‹Ÿç½‘å¡è¯»å–
   â”‚   â”œâ”€â”€ å°è£…ä¸º IPDATA æ¶ˆæ¯
   â”‚   â”œâ”€â”€ åŠ å¯†æ•°æ®åŒ…
   â”‚   â””â”€â”€ sendto() å‘é€åˆ°æœåŠ¡å™¨
   â”‚
   â””â”€â”€ å®šæ—¶å™¨è§¦å‘
       â”œâ”€â”€ Keepalive å®šæ—¶å™¨ (é»˜è®¤ 7ç§’)
       â”‚   â””â”€â”€ å‘é€ ECHO_REQ å¿ƒè·³åŒ…
       â”‚
       â”œâ”€â”€ å¥åº·è¯„ä¼°å®šæ—¶å™¨ (é»˜è®¤ 60ç§’)
       â”‚   â”œâ”€â”€ è®¡ç®—ä¸¢åŒ…ç‡ = (sent - rcvd) / sent
       â”‚   â”œâ”€â”€ è®¡ç®—å¹³å‡ RTT
       â”‚   â”œâ”€â”€ æ£€æŸ¥æ˜¯å¦è¶…è¿‡é˜ˆå€¼
       â”‚   â””â”€â”€ å†™å…¥å¥åº·æ•°æ®æ–‡ä»¶ (å¯é€‰)
       â”‚
       â””â”€â”€ é‡è¿æ£€æµ‹
           â””â”€â”€ è¶…è¿‡ reconnect_timeo æ— æ•°æ® â†’ é‡æ–°è¿æ¥

3. åŠ¨æ€é“¾è·¯ç®¡ç† (å¯é€‰)
   â”œâ”€â”€ åˆå§‹é“¾è·¯ä¸å¯åŠ¨ (dynamic_link = true)
   â”œâ”€â”€ æ”¶åˆ°ç¬¬ä¸€ä¸ªæ•°æ®åŒ…åå¯åŠ¨é“¾è·¯
   â”œâ”€â”€ å¥åº·çŠ¶æ€å·®æ—¶ç¦ç”¨é“¾è·¯
   â””â”€â”€ è°ƒæ•´è·¯ç”± metric å®ç°æ•…éšœè½¬ç§»
```

**å…³é”®å‡½æ•°**:
- `run_client()` (src/client.c:å¼€å§‹å¤„): ä¸»å¾ªç¯å…¥å£
- `network_receiving()` (src/client.c:71): å¤„ç†æœåŠ¡å™¨æ•°æ®
- `handle_link_up()` (src/client.c:34): å¯åŠ¨è™šæ‹Ÿé“¾è·¯
- `handle_link_down()` (src/client.c:62): ç¦ç”¨è™šæ‹Ÿé“¾è·¯

---

## åŠ å¯†æœºåˆ¶

### åŠ å¯†æŠ½è±¡å±‚ (`crypto_wrapper.h`)

ä½ç½®: `src/crypto_wrapper.h`

```c
// åŠ å¯†ç±»å‹æŸ¥è¯¢
const void *crypto_get_type(const char *name); // æ”¯æŒ: aes-128, aes-256, des, desx, rc4

// åˆå§‹åŒ–åŠ å¯†ä¸Šä¸‹æ–‡
struct crypto_context *crypto_init(const void *cptype, const char *password);

// åŠ å¯†æ•°æ®
int crypto_encrypt(struct crypto_context *ctx, void *in, void *out, size_t *len);

// è§£å¯†æ•°æ®
int crypto_decrypt(struct crypto_context *ctx, void *in, void *out, size_t *len);

// é‡Šæ”¾ä¸Šä¸‹æ–‡
void crypto_free(struct crypto_context *ctx);
```

### åç«¯å®ç°

1. **OpenSSL åç«¯** (`crypto_openssl.c`)
   - ä½¿ç”¨ EVP API (é«˜å±‚åŠ å¯†æ¥å£)
   - æ”¯æŒç¡¬ä»¶åŠ é€Ÿ (AES-NI)
   - PBKDF2 å¯†é’¥æ´¾ç”Ÿ (10000 è½®è¿­ä»£)

2. **mbedTLS åç«¯** (`crypto_mbedtls.c`)
   - è½»é‡çº§å®ç°ï¼Œé€‚åˆåµŒå…¥å¼è®¾å¤‡
   - æ— éœ€å¤–éƒ¨ä¾èµ–

**æ•°æ®æµ**:
```
æ˜æ–‡æ•°æ® â†’ crypto_encrypt() â†’ åŠ å¯†æ•°æ® â†’ UDP å‘é€
                                          â†“
                                    ç½‘ç»œä¼ è¾“
                                          â†“
UDP æ¥æ”¶ â†’ åŠ å¯†æ•°æ® â†’ crypto_decrypt() â†’ æ˜æ–‡æ•°æ®
```

---

## å¹³å°æŠ½è±¡å±‚

### å¹³å°æ¥å£ (`platform.h`)

```c
// åˆ›å»º TUN/TAP è®¾å¤‡
int plat_open_tun(const char *ifname, char *actual_ifname, size_t actual_ifname_len, int tap_mode);

// è®¾ç½®é“¾è·¯çŠ¶æ€
int plat_ip_link_set_updown(const char *ifname, bool up);

// æ·»åŠ  IPv4 åœ°å€
int plat_ip_addr_add_ipv4(const char *ifname, struct in_addr *loc, struct in_addr *peer, int prefix);

// æ·»åŠ è·¯ç”±
int plat_ip_route_add(short af, const char *ifname, void *network, int prefix, unsigned metric, const char *table);

// è®¾ç½® MTU
int plat_ip_link_set_mtu(const char *ifname, int mtu);
```

### å¹³å°å·®å¼‚

| åŠŸèƒ½            | Linux (platform_linux.c) | BSD/macOS (platform_bsd.c) |
|-----------------|--------------------------|----------------------------|
| TUN è®¾å¤‡è·¯å¾„    | `/dev/net/tun`           | `/dev/tunN`                |
| TAP è®¾å¤‡è·¯å¾„    | `/dev/net/tun`           | `/dev/tapN`                |
| è·¯ç”±å‘½ä»¤        | Netlink API              | `route` å‘½ä»¤               |
| åœ°å€é…ç½®        | Netlink API              | `ioctl()` SIOCAIFADDR      |
| MTU è®¾ç½®        | Netlink API              | `ioctl()` SIOCSIFMTU       |

---

## ç¼–è¯‘æ„å»º

### Makefile ç‰¹æ€§åˆ†æ

ä½ç½®: `src/Makefile`

#### 1. æ¨¡å—åŒ–ç¼–è¯‘é€‰é¡¹

```makefile
# ç‰¹æ€§å¼€å…³ (é»˜è®¤å…¨éƒ¨å¯ç”¨)
WITH_IPV6          ?= yes   # IPv6 æ”¯æŒ
WITH_DAEMONIZE     ?= yes   # å®ˆæŠ¤è¿›ç¨‹
WITH_CLIENT_MODE   ?= yes   # å®¢æˆ·ç«¯æ¨¡å¼
WITH_SERVER_MODE   ?= yes   # æœåŠ¡å™¨æ¨¡å¼
OPTIMIZE_FOR_SIZE  ?= no    # å¤§å°ä¼˜åŒ–
```

#### 2. åŠ å¯†åç«¯é€‰æ‹©

```makefile
CRYPTO_BACKEND     ?= openssl  # å¯é€‰: openssl, mbedtls
```

#### 3. å¹³å°è‡ªåŠ¨æ£€æµ‹

```makefile
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Linux)
    PLATFORM ?= linux
endif
ifeq ($(UNAME_S),FreeBSD)
    PLATFORM ?= bsd
endif
```

#### 4. ç¼–è¯‘å‘½ä»¤

```bash
# æ ‡å‡†ç¼–è¯‘ (åŠ¨æ€é“¾æ¥)
cd src && make

# äº¤å‰ç¼–è¯‘ç¤ºä¾‹
make PLATFORM=linux CRYPTO_BACKEND=mbedtls

# ä»…å®¢æˆ·ç«¯æ¨¡å¼ (èŠ‚çœç©ºé—´)
make WITH_SERVER_MODE=no OPTIMIZE_FOR_SIZE=yes

# é™æ€ç¼–è¯‘ (ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•çš„ build.sh)
./build.sh           # x86_64 é™æ€äºŒè¿›åˆ¶
./build.sh mipsel    # MIPS äº¤å‰ç¼–è¯‘
```

---

## ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ 1: åŸºæœ¬ VPN éš§é“

**æœåŠ¡å™¨** (å…¬ç½‘æœåŠ¡å™¨, IP: 1.2.3.4)
```bash
# ç›‘å¬ UDP ç«¯å£ 1414, è™šæ‹Ÿç½‘æ®µ 10.7.0.0/24, æœåŠ¡å™¨åœ°å€ 10.7.0.1
sudo minivtun -l 0.0.0.0:1414 -a 10.7.0.1/24 -e MySecretKey -d
```

**å®¢æˆ·ç«¯ A** (æœ¬åœ°æœºå™¨)
```bash
# è¿æ¥åˆ°æœåŠ¡å™¨, åˆ†é…è™šæ‹Ÿ IP 10.7.0.33
sudo minivtun -r 1.2.3.4:1414 -a 10.7.0.33/24 -e MySecretKey -d
```

**å®¢æˆ·ç«¯ B** (å¦ä¸€å°æœºå™¨)
```bash
# åˆ†é…è™šæ‹Ÿ IP 10.7.0.34
sudo minivtun -r 1.2.3.4:1414 -a 10.7.0.34/24 -e MySecretKey -d
```

**ç»“æœ**: å®¢æˆ·ç«¯ A å’Œ B å¯é€šè¿‡è™šæ‹Ÿ IP (10.7.0.33, 10.7.0.34) äº’ç›¸é€šä¿¡

### åœºæ™¯ 2: å†…ç½‘ç©¿é€ + è·¯ç”±

**æœåŠ¡å™¨** (äº‘æœåŠ¡å™¨, è®¿é—®å†…ç½‘ 192.168.1.0/24)
```bash
# é…ç½®è™šæ‹Ÿè·¯ç”±: 192.168.1.0/24 â†’ 10.7.0.100
sudo minivtun -l 0.0.0.0:1414 -a 10.7.0.1/24 \
    -e MyKey -v 192.168.1.0/24=10.7.0.100 -d
```

**å®¢æˆ·ç«¯** (å†…ç½‘æœºå™¨, IP 192.168.1.100)
```bash
# è¿æ¥æœåŠ¡å™¨, åˆ†é…è™šæ‹Ÿ IP 10.7.0.100
sudo minivtun -r cloud-server.com:1414 -a 10.7.0.100/24 \
    -e MyKey -d

# å¯ç”¨ IP è½¬å‘
sudo sysctl -w net.ipv4.ip_forward=1

# æ·»åŠ  NAT è§„åˆ™
sudo iptables -t nat -A POSTROUTING -s 10.7.0.0/24 -o eth0 -j MASQUERADE
```

**å¤–ç½‘è®¿é—®**: å…¶ä»–å®¢æˆ·ç«¯å¯é€šè¿‡éš§é“è®¿é—® 192.168.1.0/24 å†…ç½‘

### åœºæ™¯ 3: é«˜å¯ç”¨æ€§ (å¥åº·ç›‘æ§ + è‡ªåŠ¨æ•…éšœè½¬ç§»)

**ä¸»æœåŠ¡å™¨**
```bash
sudo minivtun -l 0.0.0.0:1414 -a 10.7.0.1/24 -e Key1 -d
```

**å¤‡ä»½æœåŠ¡å™¨**
```bash
sudo minivtun -l 0.0.0.0:1414 -a 10.8.0.1/24 -e Key2 -d
```

**å®¢æˆ·ç«¯** (å¤šçº¿è·¯é…ç½®)
```bash
# ä¸»çº¿è·¯ (metric=100)
sudo minivtun -r primary.com:1414 -a 10.7.0.33/24 -e Key1 \
    -M 100 -P 20 -X 200 -H /tmp/primary-health.txt -d

# å¤‡ä»½çº¿è·¯ (metric=200, ä¼˜å…ˆçº§æ›´ä½)
sudo minivtun -r backup.com:1414 -a 10.8.0.33/24 -e Key2 \
    -M 200 -d
```

**å·¥ä½œåŸç†**:
- `-P 20`: ä¸¢åŒ…ç‡è¶…è¿‡ 20% æ—¶è‡ªåŠ¨ç¦ç”¨ä¸»çº¿è·¯
- `-X 200`: RTT è¶…è¿‡ 200ms æ—¶ç¦ç”¨ä¸»çº¿è·¯
- `-M 100`: ä¸»çº¿è·¯ metric ä¸º 100
- ä¸»çº¿è·¯æ•…éšœ â†’ è·¯ç”±è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ä»½çº¿è·¯ (metric 200)

---

## å…³é”®æŠ€æœ¯ç‚¹

### 1. æ— çŠ¶æ€å¿«é€Ÿé‡è¿

**é—®é¢˜**: TCP éœ€è¦ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ï¼Œä¸­æ–­åéœ€é‡æ–°æ¡æ‰‹

**è§£å†³æ–¹æ¡ˆ**:
- ä½¿ç”¨ UDP æ— è¿æ¥åè®®
- æœåŠ¡å™¨ä¸ç»´æŠ¤ä¸¥æ ¼çš„ä¼šè¯çŠ¶æ€
- å®¢æˆ·ç«¯æ¯ä¸ªæ•°æ®åŒ…éƒ½æºå¸¦è®¤è¯ä¿¡æ¯ (`auth_key` å­—æ®µ)
- ä»ä»»æ„æ•°æ®åŒ…å³å¯æ¢å¤é€šä¿¡

**å®ç°** (src/client.c:94):
```c
if (netmsg_to_local(buffers->read_buffer, &out_data, &out_dlen) != 0) {
    LOG("Decryption failed.");
    return 0; // ä¸¢å¼ƒæ— æ•ˆåŒ…ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªæœ‰æ•ˆåŒ…
}
```

### 2. æœåŠ¡å™¨ç«¯å®¢æˆ·ç«¯ç®¡ç†

**æ•°æ®ç»“æ„** (src/server.c:80-86):
```c
struct ra_entry {
    struct list_head list;           // é“¾è¡¨èŠ‚ç‚¹
    struct sockaddr_inx real_addr;   // å®¢æˆ·ç«¯çœŸå® UDP åœ°å€
    struct timeval last_recv;        // æœ€åæ´»è·ƒæ—¶é—´
    __u16 xmit_seq;                  // å‘é€åºåˆ—å·
    int refs;                        // å¼•ç”¨è®¡æ•°
};
```

**å“ˆå¸Œè¡¨** (src/server.c:88-90):
```c
#define RA_SET_HASH_SIZE  (1 << 3)   // 8 ä¸ªæ¡¶
static struct list_head ra_set_hbase[RA_SET_HASH_SIZE];
static unsigned ra_set_len;
```

**æŸ¥æ‰¾æµç¨‹**:
1. ä½¿ç”¨ Jenkins Hash è®¡ç®—å®¢æˆ·ç«¯åœ°å€å“ˆå¸Œå€¼
2. åœ¨å¯¹åº”æ¡¶çš„é“¾è¡¨ä¸­æŸ¥æ‰¾
3. æ‰¾åˆ° â†’ æ›´æ–° `last_recv`
4. æœªæ‰¾åˆ° â†’ åˆ›å»ºæ–° `ra_entry`
5. å®šæœŸæ¸…ç†è¶…è¿‡ 300 ç§’æ— æ´»åŠ¨çš„è¿æ¥

### 3. å¥åº·çŠ¶æ€ç›‘æ§

**ç»Ÿè®¡æ¡¶æœºåˆ¶** (src/client.c):
```c
struct stats_data {
    unsigned total_echo_sent;      // å‘é€çš„å¿ƒè·³åŒ…æ•°
    unsigned total_echo_rcvd;      // æ”¶åˆ°çš„å¿ƒè·³å“åº”æ•°
    unsigned long total_rtt_ms;    // æ€»å¾€è¿”å»¶è¿Ÿ (æ¯«ç§’)
};

// ä½¿ç”¨å¤šä¸ªæ¡¶è¿›è¡Œæ»‘åŠ¨çª—å£ç»Ÿè®¡
state.stats_buckets = malloc(sizeof(struct stats_data) * config.nr_stats_buckets);
```

**è¯„ä¼°æµç¨‹**:
1. æ¯ `health_assess_interval` ç§’è¯„ä¼°ä¸€æ¬¡
2. è®¡ç®—å½“å‰æ¡¶çš„ç»Ÿè®¡æ•°æ®:
   - ä¸¢åŒ…ç‡ = (sent - rcvd) / sent * 100
   - å¹³å‡ RTT = total_rtt_ms / rcvd
3. æ£€æŸ¥æ˜¯å¦è¶…è¿‡é˜ˆå€¼ (`max_droprate`, `max_rtt`)
4. è¶…è¿‡é˜ˆå€¼ â†’ é™ä½é“¾è·¯ (å¢åŠ  metric æˆ–ç¦ç”¨æ¥å£)
5. æ¸…ç©ºå½“å‰æ¡¶, åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ¡¶

### 4. åŠ¨æ€ Metric è°ƒæ•´

**æ¦‚å¿µ**:
- Linux è·¯ç”±è¡¨ä¸­ï¼Œmetric å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜
- é€šè¿‡åŠ¨æ€è°ƒæ•´ metric å®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»

**å®ç°** (src/client.c:40, 66):
```c
// é“¾è·¯æ­£å¸¸
static void handle_link_up(void) {
    state.rt_metric = config.vt_metric; // ä½¿ç”¨é…ç½®çš„åˆå§‹ metric
    plat_ip_route_add(..., state.rt_metric, ...);
}

// é“¾è·¯æ•…éšœ
static void handle_link_down(void) {
    state.rt_metric += config.metric_stepping; // å¢åŠ  metric é™ä½ä¼˜å…ˆçº§
    plat_ip_link_set_updown(config.ifname, false);
}
```

**ç¤ºä¾‹**:
```bash
# é…ç½® metric åˆå§‹å€¼ 100, æ¯æ¬¡æ•…éšœå¢åŠ  50
minivtun -r server.com:1414 -M 100++50 ...

# è¿è¡Œè¿‡ç¨‹:
# æ­£å¸¸: metric=100 (æœ€ä¼˜)
# ç¬¬1æ¬¡æ•…éšœ: metric=150
# ç¬¬2æ¬¡æ•…éšœ: metric=200
# æ¢å¤: metric=100
```

---

## å®‰å…¨è€ƒè™‘

### 1. åŠ å¯†å¼ºåº¦

**ä¼˜ç‚¹**:
- æ”¯æŒ AES-128/256 å¼ºåŠ å¯†
- PBKDF2 å¯†é’¥æ´¾ç”Ÿ (é˜²æ­¢å¼±å¯†ç æš´åŠ›ç ´è§£)
- æ¯ä¸ªæ•°æ®åŒ…åŒ…å« 16 å­—èŠ‚è®¤è¯å¯†é’¥

**ä¸è¶³**:
- ä½¿ç”¨å¯¹ç§°åŠ å¯† (éœ€å®‰å…¨åˆ†å‘å¯†ç )
- æœªå®ç°å®Œç¾å‰å‘ä¿å¯† (PFS)
- å»ºè®®ä½¿ç”¨å¼ºå¯†ç  (â‰¥20 å­—ç¬¦)

### 2. æŠ—å®¡æŸ¥

**ä¼˜ç‚¹**:
- éæ ‡å‡†åè®®ï¼Œéš¾ä»¥ç‰¹å¾è¯†åˆ«
- åŠ å¯†å¤´éƒ¨å’Œæ•°æ®ï¼Œæ— æ˜æ–‡æ ‡è¯†

**é™åˆ¶**:
- UDP æµé‡ç‰¹å¾å¯èƒ½è¢«è¯†åˆ«
- å»ºè®®é…åˆä¼ªè£…å·¥å…· (å¦‚ obfs4)

### 3. æ‹’ç»æœåŠ¡ (DoS) é˜²æŠ¤

**æœåŠ¡å™¨ç«¯**:
- é™åˆ¶å®¢æˆ·ç«¯è¿æ¥æ•° (ra_set_len)
- è¶…æ—¶æ¸…ç†æœºåˆ¶
- å•åŒ…è§£å¯†å¤±è´¥ç›´æ¥ä¸¢å¼ƒ (ä¸æ¶ˆè€—èµ„æº)

**å»ºè®®**:
- ä½¿ç”¨ iptables é™æµ
- éƒ¨ç½²åœ¨é˜²ç«å¢™å

---

## è°ƒè¯•æŠ€å·§

### 1. å¯ç”¨æ—¥å¿—

ç¼–è¾‘ `src/log.h`:
```c
// é»˜è®¤ä½¿ç”¨ syslog
#define LOG(format, ...)  syslog(LOG_INFO, format, ##__VA_ARGS__)
#define PLOG(msg)  syslog(LOG_ERR, "%s: %s", msg, strerror(errno))

// ä¿®æ”¹ä¸º stderr è¾“å‡º (ä¾¿äºè°ƒè¯•)
#define LOG(format, ...)  fprintf(stderr, format "\n", ##__VA_ARGS__)
```

### 2. æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹ syslog
sudo tail -f /var/log/syslog | grep minivtun

# æŸ¥çœ‹å¥åº·çŠ¶æ€æ–‡ä»¶
watch -n 1 cat /tmp/health.txt
```

### 3. æŠ“åŒ…åˆ†æ

```bash
# æŠ“å–éš§é“æµé‡ (åŠ å¯†å)
sudo tcpdump -i any -n udp port 1414 -X

# æŠ“å–è™šæ‹Ÿç½‘å¡æµé‡ (æ˜æ–‡)
sudo tcpdump -i mv0 -n
```

### 4. æµ‹è¯•è¿é€šæ€§

```bash
# Ping å¯¹ç«¯è™šæ‹Ÿ IP
ping 10.7.0.1

# æµ‹è¯•å¸¦å®½
iperf3 -s                    # æœåŠ¡å™¨
iperf3 -c 10.7.0.1           # å®¢æˆ·ç«¯
```

---

## å¸¸è§é—®é¢˜

### Q1: ç¼–è¯‘å¤±è´¥ "crypto.h: No such file"

**åŸå› **: ç¼ºå°‘ OpenSSL å¼€å‘åº“

**è§£å†³**:
```bash
# Debian/Ubuntu
sudo apt-get install libssl-dev

# CentOS/RHEL
sudo yum install openssl-devel

# macOS
brew install openssl
```

### Q2: è™šæ‹Ÿç½‘å¡åˆ›å»ºå¤±è´¥

**åŸå› **: æƒé™ä¸è¶³æˆ–å†…æ ¸æ¨¡å—æœªåŠ è½½

**è§£å†³**:
```bash
# ä½¿ç”¨ root æƒé™
sudo minivtun ...

# åŠ è½½ TUN æ¨¡å— (Linux)
sudo modprobe tun
```

### Q3: å®¢æˆ·ç«¯è¿æ¥ä¸ä¸ŠæœåŠ¡å™¨

**æ’æŸ¥**:
1. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
   ```bash
   sudo iptables -A INPUT -p udp --dport 1414 -j ACCEPT
   ```
2. éªŒè¯å¯†ç ä¸€è‡´æ€§
3. æ£€æŸ¥æœåŠ¡å™¨ç«¯å£ç›‘å¬
   ```bash
   sudo netstat -unlp | grep 1414
   ```

### Q4: ä¸¢åŒ…ç‡é«˜ / å»¶è¿Ÿå¤§

**ä¼˜åŒ–**:
1. è°ƒæ•´ MTU
   ```bash
   # å‡å° MTU é¿å…åˆ†ç‰‡
   minivtun ... -m 1200
   ```
2. æ£€æŸ¥ç½‘ç»œè´¨é‡
   ```bash
   mtr server.com
   ```
3. ä½¿ç”¨æ›´å¿«çš„åŠ å¯†ç®—æ³•
   ```bash
   # RC4 é€Ÿåº¦æœ€å¿« (ä½†å®‰å…¨æ€§è¾ƒä½)
   minivtun ... -t rc4
   ```

---

## å­¦ä¹ è·¯å¾„å»ºè®®

### åˆçº§ (1-2 å‘¨)

1. **ç†è§£æ¦‚å¿µ**
   - é˜…è¯» README.md
   - å­¦ä¹  TUN/TAP åŸç†
   - äº†è§£ UDP vs TCP å·®å¼‚

2. **æ­å»ºæµ‹è¯•ç¯å¢ƒ**
   - ç¼–è¯‘æºä»£ç 
   - åœ¨æœ¬åœ°å›ç¯æµ‹è¯•
   - é…ç½®åŸºæœ¬éš§é“

3. **ä»£ç é˜…è¯»**
   - ä» `main()` å‡½æ•°å…¥æ‰‹ (src/minivtun.c)
   - è·Ÿè¸ªé…ç½®è§£ææµç¨‹
   - ç†è§£å®¢æˆ·ç«¯/æœåŠ¡å™¨åˆå§‹åŒ–

### ä¸­çº§ (2-4 å‘¨)

1. **æ·±å…¥åè®®**
   - åˆ†æ `struct minivtun_msg` ç»“æ„
   - æŠ“åŒ…è§‚å¯ŸåŠ å¯†æ•°æ®
   - ç†è§£ ECHO æœºåˆ¶

2. **å¹³å°ç§»æ¤**
   - å¯¹æ¯” Linux/BSD å®ç°å·®å¼‚
   - å°è¯•æ·»åŠ æ–°å¹³å°æ”¯æŒ (å¦‚ Windows)

3. **æ€§èƒ½ä¼˜åŒ–**
   - ä½¿ç”¨ `perf` åˆ†æç“¶é¢ˆ
   - å®éªŒä¸åŒåŠ å¯†ç®—æ³•æ€§èƒ½

### é«˜çº§ (1-2 æœˆ)

1. **åŠŸèƒ½æ‰©å±•**
   - æ·»åŠ æ–°åŠ å¯†ç®—æ³• (å¦‚ ChaCha20)
   - å®ç°å¤šçº¿ç¨‹æ”¯æŒ
   - æ·»åŠ  WebSocket ä¼ªè£…

2. **å®‰å…¨å¢å¼º**
   - å®ç°å¯†é’¥è½®æ¢
   - æ·»åŠ é‡æ”¾æ”»å‡»é˜²æŠ¤
   - é›†æˆè¯ä¹¦è®¤è¯

3. **ç”Ÿäº§éƒ¨ç½²**
   - ç¼–å†™ç³»ç»ŸæœåŠ¡æ–‡ä»¶ (systemd)
   - é…ç½®é«˜å¯ç”¨æ¶æ„
   - å®æ–½ç›‘æ§å’Œå‘Šè­¦

---

## å‚è€ƒèµ„æº

### æ–‡æ¡£
- [TUN/TAP æ¥å£åŸç†](https://www.kernel.org/doc/Documentation/networking/tuntap.txt)
- [Linux Netlink ç¼–ç¨‹](https://man7.org/linux/man-pages/man7/netlink.7.html)
- [OpenSSL EVP API](https://wiki.openssl.org/index.php/EVP)

### å·¥å…·
- **Wireshark**: æŠ“åŒ…åˆ†æ
- **iperf3**: å¸¦å®½æµ‹è¯•
- **valgrind**: å†…å­˜æ³„æ¼æ£€æµ‹
- **gdb**: æ–­ç‚¹è°ƒè¯•

### ç±»ä¼¼é¡¹ç›®
- **WireGuard**: ç°ä»£é«˜æ€§èƒ½ VPN å†…æ ¸æ¨¡å—
- **OpenVPN**: æˆç†Ÿçš„ä¼ä¸šçº§ VPN
- **SoftEther**: å¤šåè®® VPN æœåŠ¡å™¨

---

## æ€»ç»“

MiniVTun æ˜¯ä¸€ä¸ª**ç²¾ç®€è€Œå¼ºå¤§**çš„ VPN å®ç°ï¼Œéå¸¸é€‚åˆ:

- **å­¦ä¹ ç½‘ç»œç¼–ç¨‹**: ä»£ç ç®€æ´ (3000 è¡Œ), æ¶µç›– socketã€åŠ å¯†ã€è·¯ç”±ç­‰æ ¸å¿ƒæŠ€æœ¯
- **å¿«é€Ÿéƒ¨ç½²**: å•ä¸€äºŒè¿›åˆ¶æ–‡ä»¶, æ— å¤æ‚é…ç½®
- **åµŒå…¥å¼è®¾å¤‡**: ä½èµ„æºæ¶ˆè€—, æ”¯æŒé™æ€ç¼–è¯‘
- **å®éªŒæ€§åœºæ™¯**: éæ ‡å‡†åè®®, çµæ´»å¯æ‰©å±•

**æ ¸å¿ƒä¼˜åŠ¿**:
1. æ— çŠ¶æ€è®¾è®¡ â†’ å¿«é€Ÿæ¢å¤
2. å¥åº·ç›‘æ§ â†’ è‡ªåŠ¨æ•…éšœè½¬ç§»
3. æ¨¡å—åŒ–æ¶æ„ â†’ æ˜“äºå®šåˆ¶
4. è·¨å¹³å°æ”¯æŒ â†’ å¹¿æ³›å…¼å®¹

**é€‚åˆäººç¾¤**:
- C è¯­è¨€ç½‘ç»œç¼–ç¨‹å­¦ä¹ è€…
- åµŒå…¥å¼ç³»ç»Ÿå¼€å‘è€…
- VPN åè®®ç ”ç©¶äººå‘˜
- å¯¹ä¸»æµ VPN ä¸æ»¡æ„çš„æŠ€æœ¯çˆ±å¥½è€…

å¼€å§‹ä½ çš„ MiniVTun æ¢ç´¢ä¹‹æ—…å§! ğŸš€
