# HMAC éªŒè¯ä¿®å¤å®Œæˆ - æµ‹è¯•æŒ‡å—

## âœ… ä¿®å¤å·²å®Œæˆ

**é—®é¢˜**: "HMAC verification failed from client" - æ‰€æœ‰æ•°æ®åŒ…è¢«æ‹’ç»
**åŸå› **: HMAC åœ¨å¡«å……æ¶ˆæ¯å†…å®¹**ä¹‹å‰**è®¡ç®—ï¼Œå¯¼è‡´å‘é€æ–¹å’Œæ¥æ”¶æ–¹è®¡ç®—çš„ HMAC ä¸ä¸€è‡´
**ä¿®å¤**: å°†æ¶ˆæ¯å­—æ®µå¡«å……ç§»åˆ° HMAC è®¡ç®—**ä¹‹å‰** (Commit: 54961e4)

---

## ğŸ”„ æ›´æ–°å’Œæµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1: åœæ­¢å½“å‰è¿›ç¨‹

```bash
# åœæ­¢æ‰€æœ‰ minivtun è¿›ç¨‹
sudo killall minivtun
```

### æ­¥éª¤ 2: æ‹‰å–æœ€æ–°ä»£ç 

```bash
cd /path/to/minivtun
git pull origin master

# åº”è¯¥çœ‹åˆ°:
# 54961e4 - Fix HMAC verification failure - compute HMAC on complete message
```

### æ­¥éª¤ 3: é‡æ–°ç¼–è¯‘

```bash
cd src
make clean
make

# éªŒè¯ç¼–è¯‘æˆåŠŸ
ls -lh minivtun
```

### æ­¥éª¤ 4: å¯åŠ¨æœåŠ¡å™¨

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
sudo ./minivtun -l 0.0.0.0:9999 -a 10.99.0.1/24 -e "test123" -n mv0

# é¢„æœŸè¾“å‡º:
# minivtun: Bound to 0.0.0.0:9999
# minivtun: Interface mv0 configured
```

### æ­¥éª¤ 5: å¯åŠ¨å®¢æˆ·ç«¯

```bash
# åœ¨å®¢æˆ·ç«¯ä¸Šæ‰§è¡Œ (æ›¿æ¢ SERVER_IP)
sudo ./minivtun -r SERVER_IP:9999 -a 10.99.0.2/24 -e "test123" -n mv1

# é¢„æœŸè¾“å‡º:
# minivtun: Reconnected to SERVER_IP:9999
# (ä¸åº”å†æœ‰ "HMAC verification failed" é”™è¯¯)
```

### æ­¥éª¤ 6: æµ‹è¯•è¿é€šæ€§

```bash
# Ping æµ‹è¯•
ping -c 5 10.99.0.1

# é¢„æœŸè¾“å‡º:
# PING 10.99.0.1 (10.99.0.1) 56(84) bytes of data.
# 64 bytes from 10.99.0.1: icmp_seq=1 ttl=64 time=0.123 ms
# 64 bytes from 10.99.0.1: icmp_seq=2 ttl=64 time=0.089 ms
# 64 bytes from 10.99.0.1: icmp_seq=3 ttl=64 time=0.095 ms
# 64 bytes from 10.99.0.1: icmp_seq=4 ttl=64 time=0.102 ms
# 64 bytes from 10.99.0.1: icmp_seq=5 ttl=64 time=0.088 ms
#
# --- 10.99.0.1 ping statistics ---
# 5 packets transmitted, 5 received, 0% packet loss, time 4089ms
# rtt min/avg/max/mdev = 0.088/0.100/0.123/0.013 ms
```

### æ­¥éª¤ 7: é«˜çº§æµ‹è¯• (å¯é€‰)

#### TCP è¿æ¥æµ‹è¯•

```bash
# åœ¨æœåŠ¡å™¨ (10.99.0.1) ä¸Šå¯åŠ¨ HTTP æœåŠ¡
python3 -m http.server 8000

# åœ¨å®¢æˆ·ç«¯æµ‹è¯•
curl http://10.99.0.1:8000
# åº”è¯¥çœ‹åˆ°ç›®å½•åˆ—è¡¨
```

#### ååé‡æµ‹è¯•

```bash
# åœ¨æœåŠ¡å™¨ä¸Š
iperf3 -s

# åœ¨å®¢æˆ·ç«¯
iperf3 -c 10.99.0.1 -t 10

# é¢„æœŸ: åº”è¯¥çœ‹åˆ°æ­£å¸¸çš„ååé‡ç»Ÿè®¡
```

---

## ğŸ” æ•…éšœæ’é™¤

### é—®é¢˜ 1: ä»ç„¶çœ‹åˆ° "HMAC verification failed"

**å¯èƒ½åŸå› **:
- å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¯†ç ä¸ä¸€è‡´
- å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨æœªé‡æ–°ç¼–è¯‘

**è§£å†³æ–¹æ³•**:
```bash
# æ£€æŸ¥å¯†ç æ˜¯å¦ä¸€è‡´
# æœåŠ¡å™¨: -e "test123"
# å®¢æˆ·ç«¯: -e "test123"

# ç¡®ä¿ä¸¤ç«¯éƒ½é‡æ–°ç¼–è¯‘
git log -1 --oneline  # åº”è¯¥æ˜¾ç¤º 54961e4
make clean && make
```

### é—®é¢˜ 2: "Invalid protocol from tun: 0x54"

**åŸå› **: è¿™ä¸ªé—®é¢˜åº”è¯¥å·²ç»åœ¨ commit 586bc01 ä¿®å¤äº†

**éªŒè¯**:
```bash
git log --oneline | grep "IFF_NO_PI"
# åº”è¯¥çœ‹åˆ°: 586bc01 Remove IFF_NO_PI flag...
```

### é—®é¢˜ 3: ping è¶…æ—¶ä½†æ— é”™è¯¯æ¶ˆæ¯

**å¯èƒ½åŸå› **:
- é˜²ç«å¢™é˜»æ­¢ UDP 9999
- è·¯ç”±é…ç½®é—®é¢˜

**æ£€æŸ¥**:
```bash
# æ£€æŸ¥é˜²ç«å¢™
sudo iptables -L -n | grep 9999

# æ£€æŸ¥ TUN è®¾å¤‡
ip addr show mv0  # æœåŠ¡å™¨
ip addr show mv1  # å®¢æˆ·ç«¯

# æ£€æŸ¥è·¯ç”±
ip route | grep 10.99.0
```

---

## ğŸ“Š æ‰€æœ‰ä¿®å¤æ€»ç»“

| Commit | é—®é¢˜ | ä¿®å¤ |
|--------|------|------|
| 6f0aa8b | Bool ç±»å‹å†²çª | ç§»é™¤ stdbool.h |
| 76285ff | msg_len æœªå£°æ˜ | æ·»åŠ å˜é‡å£°æ˜ |
| 586bc01 | TUN åè®®é”™è¯¯ 0x54 | ç§»é™¤ IFF_NO_PI |
| 54961e4 | HMAC éªŒè¯å¤±è´¥ | ä¿®æ­£å­—æ®µå¡«å……é¡ºåº |

---

## âœ… éªŒè¯æ¸…å•

æµ‹è¯•å®Œæˆåï¼Œç¡®è®¤ä»¥ä¸‹å„é¡¹:

- [ ] ç¼–è¯‘æ— é”™è¯¯æ— è­¦å‘Š
- [ ] æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ
- [ ] å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ
- [ ] **æ—  "HMAC verification failed" é”™è¯¯**
- [ ] **æ—  "Invalid protocol from tun" é”™è¯¯**
- [ ] ping æˆåŠŸ (0% ä¸¢åŒ…)
- [ ] TCP è¿æ¥æ­£å¸¸ (å¯é€‰)
- [ ] æ€§èƒ½æµ‹è¯•æ­£å¸¸ (å¯é€‰)

---

## ğŸ¯ å®Œæ•´çš„å¯åŠ¨å‘½ä»¤

### æœåŠ¡å™¨

```bash
cd /path/to/minivtun/src
sudo ./minivtun \
  -l 0.0.0.0:9999 \
  -a 10.99.0.1/24 \
  -e "YourSecurePassword2026" \
  -n mv0
```

### å®¢æˆ·ç«¯

```bash
cd /path/to/minivtun/src
sudo ./minivtun \
  -r SERVER_IP:9999 \
  -a 10.99.0.2/24 \
  -e "YourSecurePassword2026" \
  -n mv1
```

### é‡è¦å‚æ•°è¯´æ˜

- `-l`: æœåŠ¡å™¨ç›‘å¬åœ°å€å’Œç«¯å£
- `-r`: è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨ (å®¢æˆ·ç«¯)
- `-a`: è™šæ‹Ÿ TUN æ¥å£ IP åœ°å€å’Œæ©ç 
- `-e`: åŠ å¯†å¯†ç  (**å¿…é¡»ä¸€è‡´**)
- `-n`: TUN æ¥å£åç§°

---

## ğŸ” å®‰å…¨å»ºè®®

1. **ä½¿ç”¨å¼ºå¯†ç **:
   ```bash
   # ç”Ÿæˆéšæœºå¯†ç 
   openssl rand -base64 32
   ```

2. **ä½¿ç”¨ç¯å¢ƒå˜é‡** (é¿å…å‘½ä»¤è¡Œæš´éœ²å¯†ç ):
   ```bash
   export MINIVTUN_PASSWORD="YourSecurePassword2026"
   sudo -E ./minivtun -l 0.0.0.0:9999 -a 10.99.0.1/24 -e "$MINIVTUN_PASSWORD" -n mv0
   ```

3. **é™åˆ¶ç«¯å£è®¿é—®**:
   ```bash
   # ä»…å…è®¸ç‰¹å®š IP è¿æ¥
   sudo iptables -A INPUT -p udp --dport 9999 -s CLIENT_IP -j ACCEPT
   sudo iptables -A INPUT -p udp --dport 9999 -j DROP
   ```

---

## ğŸ“ æ—¥å¿—æŸ¥çœ‹

æŸ¥çœ‹è¯¦ç»†æ—¥å¿— (å¦‚æœæœ‰é—®é¢˜):

```bash
# æ–¹æ³• 1: å‰å°è¿è¡ŒæŸ¥çœ‹è¾“å‡º
sudo ./minivtun -l 0.0.0.0:9999 -a 10.99.0.1/24 -e "test123" -n mv0

# æ–¹æ³• 2: æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
sudo tail -f /var/log/syslog | grep minivtun

# æ–¹æ³• 3: ä½¿ç”¨ journalctl (systemd)
sudo journalctl -f | grep minivtun
```

---

## ğŸ‰ æˆåŠŸæ ‡å¿—

å¦‚æœçœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼Œè¯´æ˜ HMAC è®¤è¯**æ­£å¸¸å·¥ä½œ**:

**æœåŠ¡å™¨ç«¯**:
```
minivtun: Bound to 0.0.0.0:9999
minivtun: Online clients: 1, addresses: 1
```

**å®¢æˆ·ç«¯ç«¯**:
```
minivtun: Reconnected to SERVER_IP:9999
(æ²¡æœ‰ HMAC verification failed é”™è¯¯)
```

**Ping æµ‹è¯•**:
```
5 packets transmitted, 5 received, 0% packet loss
```

---

**å½“å‰ç‰ˆæœ¬**: Commit 54961e4
**çŠ¶æ€**: âœ… æ‰€æœ‰å·²çŸ¥é—®é¢˜å·²ä¿®å¤
**å»ºè®®**: ç«‹å³æ›´æ–°å¹¶æµ‹è¯•

ğŸš€ **å‡†å¤‡å¥½åæ‰§è¡Œä¸Šè¿°æ­¥éª¤ 1-6 å³å¯!**
