# ğŸ” HMAC åŠ å¯†é¡ºåºé—®é¢˜å›¾è§£

## å½“å‰å®ç° (Encrypt-and-MAC) - âŒ ä¸å®‰å…¨

```
å‘é€æ–¹æµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å¡«å……æ¶ˆæ¯   â”‚  nmsg->ipdata.proto = pi->proto;
â”‚   å­—æ®µ       â”‚  nmsg->ipdata.ip_dlen = htons(ip_dlen);
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  memcpy(nmsg->ipdata.data, pi + 1, ip_dlen);
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è®¡ç®— HMAC  â”‚  crypto_compute_hmac(nmsg, msg_len,
â”‚   (æ˜æ–‡)      â”‚      nmsg->hdr.auth_key, 16);
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â† å¯¹æ˜æ–‡è®¡ç®— HMACï¼
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. åŠ å¯†       â”‚  local_to_netmsg(nmsg, &out_data, &out_dlen);
â”‚   æ¶ˆæ¯+HMAC   â”‚  â† åŠ å¯†æ•´ä¸ªæ¶ˆæ¯ï¼ˆåŒ…æ‹¬ HMAC æ ‡ç­¾ï¼‰
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å‘é€       â”‚  send(sockfd, out_data, out_dlen, 0);
â”‚   å¯†æ–‡       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¥æ”¶æ–¹æµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ¥æ”¶       â”‚  recvfrom(sockfd, buffer, size, 0, ...);
â”‚   å¯†æ–‡       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è§£å¯†       â”‚  netmsg_to_local(buffer, &out_data, &out_dlen);
â”‚   æ¶ˆæ¯+HMAC   â”‚  â† å¿…é¡»å…ˆè§£å¯†ï¼ˆè®¡ç®—å¯†é›†å‹ï¼ï¼‰
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. éªŒè¯ HMAC  â”‚  crypto_verify_hmac(nmsg, out_dlen);
â”‚   (æ˜æ–‡)      â”‚  â† å¦‚æœéªŒè¯å¤±è´¥ï¼Œä¹‹å‰çš„è§£å¯†å·¥ä½œç™½è´¹äº†
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å¤„ç†æ¶ˆæ¯   â”‚  switch (nmsg->hdr.opcode) { ... }
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜:
âŒ 1. æ”»å‡»è€…å¯ä»¥å‘é€å¤§é‡ä¼ªé€ æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨å¿…é¡»è§£å¯†æ¯ä¸€ä¸ª
âŒ 2. "Decryption failed" vs "HMAC failed" æ³„éœ²ä¿¡æ¯ï¼ˆå¡«å……é¢„è¨€æ”»å‡»ï¼‰
âŒ 3. è§£å¯†æ—¶é—´å·®å¼‚å¯èƒ½æ³„éœ²æ˜æ–‡ä¿¡æ¯ï¼ˆæ—¶åºä¾§ä¿¡é“ï¼‰
```

---

## æ­£ç¡®å®ç° (Encrypt-then-MAC) - âœ… å®‰å…¨

```
å‘é€æ–¹æµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å¡«å……æ¶ˆæ¯   â”‚  nmsg->ipdata.proto = pi->proto;
â”‚   å­—æ®µ       â”‚  nmsg->ipdata.ip_dlen = htons(ip_dlen);
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  memcpy(nmsg->ipdata.data, pi + 1, ip_dlen);
       â”‚          memset(nmsg->hdr.auth_key, 0, 16);  â† æ¸…é›¶ HMAC å­—æ®µ
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. åŠ å¯†       â”‚  local_to_netmsg(nmsg, &out_data, &out_dlen);
â”‚   æ¶ˆæ¯       â”‚  â† å…ˆåŠ å¯†æ¶ˆæ¯ï¼ˆHMAC å­—æ®µä¸º 0ï¼‰
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è®¡ç®— HMAC  â”‚  struct minivtun_msg *enc = (void*)out_data;
â”‚   (å¯†æ–‡)      â”‚  crypto_compute_hmac(enc, out_dlen,
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      enc->hdr.auth_key, 16);  â† å¯¹å¯†æ–‡è®¡ç®— HMAC
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å‘é€       â”‚  send(sockfd, out_data, out_dlen, 0);
â”‚   å¯†æ–‡+HMAC   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¥æ”¶æ–¹æµç¨‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ¥æ”¶       â”‚  recvfrom(sockfd, buffer, size, 0, ...);
â”‚   å¯†æ–‡+HMAC   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. éªŒè¯ HMAC  â”‚  crypto_verify_hmac(buffer, rc);
â”‚   (å¯†æ–‡)      â”‚  â† å…ˆéªŒè¯ HMACï¼ˆè½»é‡çº§æ“ä½œï¼‰
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ HMAC æ— æ•ˆ?
       â”‚ â”œâ”€ æ˜¯ â†’ ç›´æ¥æ‹’ç»ï¼Œä¸è§£å¯†ï¼âœ…
       â”‚ â””â”€ å¦ â†’ ç»§ç»­
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è§£å¯†       â”‚  netmsg_to_local(buffer, &out_data, &out_dlen);
â”‚   æ¶ˆæ¯       â”‚  â† åªè§£å¯†å·²éªŒè¯çš„æ¶ˆæ¯ï¼ˆèŠ‚çœ CPUï¼‰
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å¤„ç†æ¶ˆæ¯   â”‚  switch (nmsg->hdr.opcode) { ... }
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿:
âœ… 1. ä¼ªé€ æ¶ˆæ¯åœ¨ HMAC éªŒè¯é˜¶æ®µè¢«æ‹’ç»ï¼Œæ— éœ€è§£å¯†ï¼ˆé˜² DoSï¼‰
âœ… 2. æ”»å‡»è€…æ— æ³•åŒºåˆ†"å¯†æ–‡è¢«ç¯¡æ”¹"å’Œ"å¯†é’¥é”™è¯¯"ï¼ˆé˜²å¡«å……é¢„è¨€æ”»å‡»ï¼‰
âœ… 3. è§£å¯†åªåœ¨ HMAC é€šè¿‡åæ‰§è¡Œï¼Œæ— æ—¶åºæ³„éœ²
```

---

## æ”»å‡»åœºæ™¯ç¤ºä¾‹

### åœºæ™¯ 1: å¡«å……é¢„è¨€æ”»å‡» (Padding Oracle Attack)

**å½“å‰å®ç° (Encrypt-and-MAC) - å¯è¢«æ”»å‡»**:
```
æ”»å‡»è€…æ“ä½œ:
1. æˆªè·å¯†æ–‡: C = Encrypt(Message + HMAC)
2. ä¿®æ”¹å¯†æ–‡æœ€åä¸€ä¸ªå­—èŠ‚: C' = C[0:-1] + modified_byte
3. å‘é€ C' åˆ°æœåŠ¡å™¨

æœåŠ¡å™¨å“åº”:
Case A: "Decryption failed" â†’ å¡«å……æ— æ•ˆ â†’ ä¿¡æ¯æ³„éœ²ï¼
Case B: "HMAC verification failed" â†’ å¡«å……æœ‰æ•ˆï¼Œä½†å†…å®¹è¢«ç¯¡æ”¹ â†’ ä¿¡æ¯æ³„éœ²ï¼

æ”»å‡»è€…é€šè¿‡è§‚å¯Ÿå“åº”ç±»å‹ï¼Œå¯ä»¥é€å­—èŠ‚æ¢å¤æ˜æ–‡:
å°è¯• 256 ä¸ªå¯èƒ½çš„å­—èŠ‚ â†’ è§‚å¯Ÿå“åº” â†’ æ¨æ–­æ­£ç¡®çš„å¡«å…… â†’ æ¢å¤ä¸€ä¸ªå­—èŠ‚
é‡å¤ â†’ å®Œå…¨æ¢å¤æ˜æ–‡
```

**ä¿®å¤å (Encrypt-then-MAC) - æ”»å‡»å¤±è´¥**:
```
æ”»å‡»è€…æ“ä½œ:
1. æˆªè·å¯†æ–‡: C = Encrypt(Message) || HMAC(C)
2. ä¿®æ”¹å¯†æ–‡: C' = modified(C) || HMAC(C)  â† HMAC ä¸åŒ¹é…
3. å‘é€ C' åˆ°æœåŠ¡å™¨

æœåŠ¡å™¨å“åº”:
"HMAC verification failed" (ä¸è§£å¯†)

æ”»å‡»è€…æ— æ³•è·å¾—ä»»ä½•å…³äºå¡«å……çš„ä¿¡æ¯ â†’ æ”»å‡»å¤±è´¥ï¼
```

---

### åœºæ™¯ 2: DoS æ”»å‡»

**å½“å‰å®ç° (Encrypt-and-MAC) - æ˜“å—æ”»å‡»**:
```
æ”»å‡»è€…å‘é€ 10,000 ä¸ªä¼ªé€ æ¶ˆæ¯

æœåŠ¡å™¨å¤„ç†:
For each message:
    1. è§£å¯† (è®¡ç®—å¯†é›†å‹: AES æ“ä½œ)  â† CPU é«˜è´Ÿè½½
    2. HMAC éªŒè¯å¤±è´¥
    3. ä¸¢å¼ƒæ¶ˆæ¯

ç»“æœ: æœåŠ¡å™¨ CPU æ¥è¿‘ 100%ï¼Œæ— æ³•å¤„ç†åˆæ³•æµé‡
```

**ä¿®å¤å (Encrypt-then-MAC) - é˜²æŠ¤æœ‰æ•ˆ**:
```
æ”»å‡»è€…å‘é€ 10,000 ä¸ªä¼ªé€ æ¶ˆæ¯

æœåŠ¡å™¨å¤„ç†:
For each message:
    1. HMAC éªŒè¯ (è½»é‡çº§: SHA-256 å“ˆå¸Œ)  â† CPU ä½è´Ÿè½½
    2. éªŒè¯å¤±è´¥ï¼Œç›´æ¥æ‹’ç»ï¼Œä¸è§£å¯†

ç»“æœ: æœåŠ¡å™¨ CPU ä½¿ç”¨ç‡ä½ï¼Œå¯æ­£å¸¸å¤„ç†åˆæ³•æµé‡
```

---

## ä»£ç å¯¹æ¯”

### å‘é€æ–¹: client.c tunnel_receiving()

**å½“å‰ä»£ç ** (Lines 200-221):
```c
// âŒ é”™è¯¯é¡ºåº
nmsg->ipdata.proto = pi->proto;
nmsg->ipdata.ip_dlen = htons(ip_dlen);
memcpy(nmsg->ipdata.data, pi + 1, ip_dlen);

/* å…ˆè®¡ç®— HMAC (æ˜æ–‡) */
if (state.crypto_ctx) {
    crypto_compute_hmac(state.crypto_ctx, nmsg, msg_len,
                        nmsg->hdr.auth_key, 16);
}

/* ååŠ å¯† */
local_to_netmsg(nmsg, &out_data, &out_dlen);
send(state.sockfd, out_data, out_dlen, 0);
```

**ä¿®å¤å**:
```c
// âœ… æ­£ç¡®é¡ºåº
nmsg->ipdata.proto = pi->proto;
nmsg->ipdata.ip_dlen = htons(ip_dlen);
memcpy(nmsg->ipdata.data, pi + 1, ip_dlen);
memset(nmsg->hdr.auth_key, 0, 16);  // â† æ¸…é›¶ HMAC å­—æ®µ

/* å…ˆåŠ å¯† */
local_to_netmsg(nmsg, &out_data, &out_dlen);

/* åè®¡ç®— HMAC (å¯†æ–‡) */
if (state.crypto_ctx) {
    struct minivtun_msg *encrypted = (struct minivtun_msg *)out_data;
    crypto_compute_hmac(state.crypto_ctx, encrypted, out_dlen,
                        encrypted->hdr.auth_key, 16);
}

send(state.sockfd, out_data, out_dlen, 0);
```

---

### æ¥æ”¶æ–¹: client.c network_receiving()

**å½“å‰ä»£ç ** (Lines 87-109):
```c
// âŒ é”™è¯¯é¡ºåº
rc = recvfrom(state.sockfd, buffer, size, 0, ...);

/* å…ˆè§£å¯† */
netmsg_to_local(buffer, &out_data, &out_dlen);

/* åéªŒè¯ HMAC */
if (state.crypto_ctx) {
    if (!crypto_verify_hmac(state.crypto_ctx, nmsg, out_dlen)) {
        return 0;
    }
}
```

**ä¿®å¤å**:
```c
// âœ… æ­£ç¡®é¡ºåº
rc = recvfrom(state.sockfd, buffer, size, 0, ...);

struct minivtun_msg *encrypted = (struct minivtun_msg *)buffer;

/* å…ˆéªŒè¯ HMAC (å¯†æ–‡) */
if (state.crypto_ctx) {
    if (!crypto_verify_hmac(state.crypto_ctx, encrypted, (size_t)rc)) {
        return 0;  // â† æå‰æ‹’ç»ï¼Œæ— éœ€è§£å¯†
    }
}

/* åè§£å¯† */
netmsg_to_local(buffer, &out_data, &out_dlen);
```

---

## æ€»ç»“

| å®ç°æ–¹å¼ | å½“å‰ (Encrypt-and-MAC) | ä¿®å¤å (Encrypt-then-MAC) |
|---------|----------------------|-------------------------|
| **HMAC æ—¶æœº (å‘é€)** | åŠ å¯†å‰ âŒ | åŠ å¯†å âœ… |
| **HMAC æ—¶æœº (æ¥æ”¶)** | è§£å¯†å âŒ | è§£å¯†å‰ âœ… |
| **å¡«å……é¢„è¨€æ”»å‡»** | æ˜“å—æ”»å‡» âŒ | é˜²æŠ¤æœ‰æ•ˆ âœ… |
| **DoS æ”»å‡»** | æ˜“å—æ”»å‡» âŒ | é˜²æŠ¤æœ‰æ•ˆ âœ… |
| **æ—¶åºä¾§ä¿¡é“** | å¯èƒ½æ³„éœ² âŒ | æ— æ³„éœ² âœ… |
| **CPU æ•ˆç‡** | ä½ (éœ€è§£å¯†æ‰€æœ‰æ¶ˆæ¯) âŒ | é«˜ (åªè§£å¯†åˆæ³•æ¶ˆæ¯) âœ… |
| **ä¸šç•Œæ ‡å‡†** | ä¸ç¬¦åˆ âŒ | ç¬¦åˆ (RFC 7366) âœ… |

**ä¿®å¤ä¼˜å…ˆçº§**: ğŸ”´ **P0 (ç«‹å³)**
**ä¿®å¤å¤æ‚åº¦**: ğŸŸ¡ **ä¸­ç­‰** (è°ƒæ•´ä»£ç é¡ºåºï¼Œéœ€ä»”ç»†æµ‹è¯•)
**é¢„è®¡å·¥ä½œé‡**: â±ï¸ **4-6 å°æ—¶**
